# ๐ ะะฑะทะพั ะฐััะธัะตะบัััั ะฟัะพะตะบัะฐ VpnGatekeeper (ะฒะตััะธั 3.0)

ะญัะพั ะดะพะบัะผะตะฝั ะฟัะตะดะพััะฐะฒะปัะตั ะพะฑะฝะพะฒะปะตะฝะฝัะน ะพะฑะทะพั ะฐััะธัะตะบัััั, ะพะฟะธัะฐะฝะธะต ะบะพะผะฟะพะฝะตะฝัะพะฒ ะฝะฐ ะพัะฝะพะฒะต `docker-compose.yml` ะธ ัะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ะดะฐะปัะฝะตะนัะตะน ัะฐะทัะฐะฑะพัะบะต.

## 1. ะะฑะทะพั ะบะพะผะฟะพะฝะตะฝัะพะฒ ะธ ะธั ะฒะทะฐะธะผะพะดะตะนััะฒะธะต

ะกะธััะตะผะฐ ัะฐะทะฒะตัะฝััะฐ ะบะฐะบ ะฝะฐะฑะพั ะผะธะบัะพัะตัะฒะธัะพะฒ ั ะฟะพะผะพััั Docker. ะะธะถะต ะฟัะตะดััะฐะฒะปะตะฝะพ ะพะฟะธัะฐะฝะธะต ะบะฐะถะดะพะณะพ ะบะพะผะฟะพะฝะตะฝัะฐ ะธ ััะตะผะฐ ะธั ะฒะทะฐะธะผะพะดะตะนััะฒะธั.

### ะะพะผะฟะพะฝะตะฝัั

#### 1. `django_api` (Backend)
- **ะะพะปั**: ะฆะตะฝััะฐะปัะฝัะน ะบะพะผะฟะพะฝะตะฝั, ะฟัะตะดะพััะฐะฒะปัััะธะน REST API ะดะปั ะฒัะตั ะบะปะธะตะฝััะบะธั ะฟัะธะปะพะถะตะฝะธะน. ะะฑัะฐะฑะฐััะฒะฐะตั ะฑะธะทะฝะตั-ะปะพะณะธะบั, ะฒะทะฐะธะผะพะดะตะนััะฒัะตั ั ะฑะฐะทะพะน ะดะฐะฝะฝัั ะธ ััะฐะฒะธั ะทะฐะดะฐัะธ ะฒ ะพัะตัะตะดั ะดะปั ัะพะฝะพะฒะพะน ะพะฑัะฐะฑะพัะบะธ.
- **ะกัะตะบ**: Python, Django, Django REST Framework.
- **ะะพะฝัะธะณััะฐัะธั ะฒ `docker-compose.yml`**:
    - ะกะพะฑะธัะฐะตััั ะธะท ะดะธัะตะบัะพัะธะธ `./django_api`.
    - ะะฐะฟััะบะฐะตััั ะฝะฐ ะฟะพััั `8000` ะธ ะดะพัััะฟะตะฝ ะฒะฝัััะธ Docker-ัะตัะธ ะฟะพ ะธะผะตะฝะธ `django:8000`.
    - ะะฐะฒะธัะธั ะพั `db` ะธ `redis`.
    - ะัะฟะพะปัะทัะตั ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะดะปั ะฟะพะดะบะปััะตะฝะธั ะบ PostgreSQL ะธ Redis.

#### 2. `miniapp` (Frontend)
- **ะะพะปั**: ะะปะธะตะฝััะบะพะต ะฟัะธะปะพะถะตะฝะธะต (Telegram Mini App) ะดะปั ะฒะทะฐะธะผะพะดะตะนััะฒะธั ั ะฟะพะปัะทะพะฒะฐัะตะปะตะผ. ะัะตะดะพััะฐะฒะปัะตั ะธะฝัะตััะตะนั ะดะปั ัะฟัะฐะฒะปะตะฝะธั ััะปัะณะฐะผะธ.
- **ะกัะตะบ**: Node.js, Next.js, React.
- **ะะพะฝัะธะณััะฐัะธั ะฒ `docker-compose.yml`**:
    - ะกะพะฑะธัะฐะตััั ะธะท ะดะธัะตะบัะพัะธะธ `./miniapp`.
    - ะะฐะฟััะบะฐะตััั ะฒ ัะตะถะธะผะต ัะฐะทัะฐะฑะพัะบะธ (`npm run dev`) ะฝะฐ ะฟะพััั `3000`.
    - ะะฐะฒะธัะธั ะพั `django_api` (ะดะปั API ะทะฐะฟัะพัะพะฒ) ะธ `redis`.

#### 3. `bot` (Telegram Bot)
- **ะะพะปั**: ะัะฟะพะปะฝัะตั ะดะฒะต ััะฝะบัะธะธ:
    1. **ะขะพัะบะฐ ะฒัะพะดะฐ**: ะะฑัะฐะฑะฐััะฒะฐะตั ะบะพะผะฐะฝะดั `/start` ะธ ะฟัะตะดะพััะฐะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะบะฝะพะฟะบั ะดะปั ะพัะบัััะธั `miniapp`.
    2. **ะกะธััะตะผะฐ ัะฒะตะดะพะผะปะตะฝะธะน**: ะัะธะฝััะพะฝะฝะพ ะฒะทะฐะธะผะพะดะตะนััะฒัะตั ั `django_api` ะดะปั ะฟัะพะฒะตัะบะธ ััะฐัััะพะฒ ะฟะพะดะฟะธัะพะบ ะธ ะพัะฟัะฐะฒะบะธ ัะฒะตะดะพะผะปะตะฝะธะน.
- **ะกัะตะบ**: Python, aiogram.
- **ะะพะฝัะธะณััะฐัะธั ะฒ `docker-compose.yml`**:
    - ะกะพะฑะธัะฐะตััั ะธะท ะดะธัะตะบัะพัะธะธ `./bot`.
    - ะะฐะฒะธัะธั ะพั `django_api`.
    - ะะทะฐะธะผะพะดะตะนััะฒัะตั ั API ะฑัะบะตะฝะดะฐ ะฟะพ ะฒะฝัััะตะฝะฝะตะผั ะฐะดัะตัั `http://django:8000`, ะบะพัะพััะน ัะบะฐะทะฐะฝ ะฒ ะฟะตัะตะผะตะฝะฝะพะน ะพะบััะถะตะฝะธั `API_URL`.

#### 4. `celery_worker` (Background Tasks)
- **ะะพะปั**: ะคะพะฝะพะฒัะน ะพะฑัะฐะฑะพััะธะบ ะทะฐะดะฐั. ะัะฟะพะปะฝัะตั ะดะปะธัะตะปัะฝัะต ะธะปะธ ะฟะตัะธะพะดะธัะตัะบะธะต ะพะฟะตัะฐัะธะธ, ัะฝัััะต ั `django_api`. ะะฐะฟัะธะผะตั: ัะพะทะดะฐะฝะธะต VPN-ะบะพะฝัะธะณััะฐัะธะน, ะฟัะพะฒะตัะบะฐ ะธััะตะบะฐััะธั ะฟะพะดะฟะธัะพะบ, ัะฐัััะปะบะธ.
- **ะกัะตะบ**: Python, Celery.
- **ะะพะฝัะธะณััะฐัะธั ะฒ `docker-compose.yml`**:
    - ะัะฟะพะปัะทัะตั ัะพั ะถะต ะพะฑัะฐะท, ััะพ ะธ `django_api`.
    - ะะฐะฟััะบะฐะตั Celery worker.
    - ะะฐะฒะธัะธั ะพั `django_api` ะธ `redis`.

#### 5. `db` (Database)
- **ะะพะปั**: ะัะฝะพะฒะฝะพะต ััะฐะฝะธะปะธัะต ะดะฐะฝะฝัั ะฟัะธะปะพะถะตะฝะธั.
- **ะกัะตะบ**: PostgreSQL 15.
- **ะะพะฝัะธะณััะฐัะธั ะฒ `docker-compose.yml`**:
    - ะัะฟะพะปัะทัะตั ะพัะธัะธะฐะปัะฝัะน ะพะฑัะฐะท `postgres:15`.
    - ะะฐะฝะฝัะต ััะฐะฝัััั ะฒ Docker Volume `postgres_data` ะดะปั ะฟะตััะธััะตะฝัะฝะพััะธ.
    - ะะพัั `5432` ะดะพัััะฟะตะฝ ะดะปั ะฟะพะดะบะปััะตะฝะธั ั ัะพัั-ะผะฐัะธะฝั (ัะดะพะฑะฝะพ ะดะปั ะพัะปะฐะดะบะธ).

#### 6. `redis` (Broker / Cache)
- **ะะพะปั**: ะัะฟะพะปะฝัะตั ะดะฒะต ััะฝะบัะธะธ:
    1. **ะัะพะบะตั ัะพะพะฑัะตะฝะธะน**: ะกะปัะถะธั ะดะปั ะพะฑะผะตะฝะฐ ะทะฐะดะฐัะฐะผะธ ะผะตะถะดั `django_api` ะธ `celery_worker`.
    2. **ะัั**: ะะพะถะตั ะธัะฟะพะปัะทะพะฒะฐัััั ะดะปั ะบััะธัะพะฒะฐะฝะธั ะดะฐะฝะฝัั.
- **ะกัะตะบ**: Redis 7.
- **ะะพะฝัะธะณััะฐัะธั ะฒ `docker-compose.yml`**:
    - ะัะฟะพะปัะทัะตั ะพัะธัะธะฐะปัะฝัะน ะพะฑัะฐะท `redis:7-alpine`.
    - ะะพัััะฟะตะฝ ะฒะฝัััะธ Docker-ัะตัะธ ะฟะพ ะธะผะตะฝะธ `redis`.

### ะกัะตะผะฐ ะฒะทะฐะธะผะพะดะตะนััะฒะธั

```
                         โโโโโโโโโโโโโโโโโโโโ
(ะะฝัะตัะฝะตั)โโโโโโโโโโโโโโ>โ  miniapp (3000)  โ (Next.js)
                         โโโโโโโโโโฌโโโโโโโโโโ
                                  โ
                                  โ (HTTP API ะทะฐะฟัะพัั)
                                  โ
                         โโโโโโโโโโผโโโโโโโโโโ
(Telegram API)โโโโโโโโโโ>โ   bot (aiogram)  โ
                         โโโโโโโโโโฌโโโโโโโโโโ
                                  โ
                                  โ (HTTP API ะทะฐะฟัะพัั ะฟะพ `http://django:8000`)
                                  โ
         โโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโ
         โ                        โ                       โ
โโโโโโโโโโผโโโโโโโโโโ     โโโโโโโโโโผโโโโโโโโโโโ     โโโโโโโโผโโโโโโโโโโโ
โ celery_worker    โ<โโโ>โ  redis (Broker)   โ<โโโ>โ django_api(8000)โ
โ (Background Job) โ     โโโโโโโโโโโโโโโโโโโโโ     โ (Django)        โ
โโโโโโโโโโโโโโโโโโโโ                               โโโโโโโโโโฌโโโโโโโโโ
                                                         โ (SQL)
                                                         โ
                                                  โโโโโโโโผโโโโโโโ
                                                  โ db (Postgr) โ
                                                  โโโโโโโโโโโโโโโ
```

---

## 2. ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ะดะฐะปัะฝะตะนัะตะน ัะฐะฑะพัะต

### โ ะะฐะถะฝะพ: ะะฝะตะดัะตะฝะธะต ะฐััะตะฝัะธัะธะบะฐัะธะธ ะฟะพ ะปะพะณะธะฝั ะธ ะฟะฐัะพะปั (JWT)

ะขะตะบััะฐั ัะตะฐะปะธะทะฐัะธั API ะฝะต ะทะฐัะธัะตะฝะฐ. ะะตะบะพะผะตะฝะดัะตััั ะฒะฝะตะดัะธัั ััะฐะฝะดะฐััะฝัั ะฐััะตะฝัะธัะธะบะฐัะธั ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ JWT.

**ะัะตะดะปะฐะณะฐะตะผัะน ะฟะปะฐะฝ:**

1.  **ะะฝัะตะณัะฐัะธั `djangorestframework-simplejwt`**: ะะพะฑะฐะฒััะต ะฑะธะฑะปะธะพัะตะบั ะฒ `django_api/requirements.txt`.
2.  **ะะพะดะธัะธะบะฐัะธั ะผะพะดะตะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั**:
    *   ะะฝัะตะณัะธััะนัะต ััะฐะฝะดะฐััะฝัั ะผะพะดะตะปั `django.contrib.auth.models.User` ะดะปั ััะฐะฝะตะฝะธั ััะตัะฝัั ะดะฐะฝะฝัั (ะปะพะณะธะฝ, ะฟะฐัะพะปั).
    *   ะกะฒัะถะธัะต `User` ะธ `TelegramUser` ะพัะฝะพัะตะฝะธะตะผ "ะพะดะธะฝ ะบ ะพะดะฝะพะผั" (`OneToOneField`), ััะพะฑั ัะพััะฐะฝะธัั ัััะตััะฒััััั ะปะพะณะธะบั ะธ ะดะพะฑะฐะฒะธัั ะฒะพะทะผะพะถะฝะพััั ะฒัะพะดะฐ ะฟะพ ะฟะฐัะพะปั.
3.  **ะะฐัััะพะนะบะฐ `settings.py`**: ะะพะฑะฐะฒััะต `rest_framework_simplejwt` ะฒ `INSTALLED_APPS` ะธ ะฝะฐัััะพะนัะต `DEFAULT_AUTHENTICATION_CLASSES` ะฒ `REST_FRAMEWORK`.
4.  **ะกะพะทะดะฐะฝะธะต ัะฝะดะฟะพะธะฝัะพะฒ ะดะปั ัะพะบะตะฝะพะฒ**: ะะพะฑะฐะฒััะต ะฒ `backend/urls.py` ะฟััะธ ะดะปั ะฟะพะปััะตะฝะธั (`/api/token/`) ะธ ะพะฑะฝะพะฒะปะตะฝะธั (`/api/token/refresh/`) JWT.
5.  **ะกะพะทะดะฐะฝะธะต ัะฝะดะฟะพะธะฝัะฐ ะดะปั ัะตะณะธัััะฐัะธะธ**: ะะตะฐะปะธะทัะนัะต View ะดะปั ัะพะทะดะฐะฝะธั ะฟะฐัั `User` ะธ `TelegramUser` ะฝะฐ ะพัะฝะพะฒะต ะฟะพะปััะตะฝะฝัั ะดะฐะฝะฝัั.
6.  **ะะฐัะธัะฐ View**: ะะพะฑะฐะฒััะต `permission_classes = [IsAuthenticated]` ะฒ `ViewSet`, ะบะพัะพััะต ััะตะฑััั ะฐััะตะฝัะธัะธะบะฐัะธะธ.

### ะัะพัะธะต ัะตะบะพะผะตะฝะดะฐัะธะธ

*   **ะะฐััะธัะตะฝะธะต `user` ัะฝะดะฟะพะธะฝัะฐ**: ะกะพะทะดะฐะนัะต ะฒ Django ัะฝะดะฟะพะธะฝั `/api/users/me/`, ะบะพัะพััะน ะฑัะดะตั ะฒะพะทะฒัะฐัะฐัั ะฟะพะปะฝัั ะธะฝัะพัะผะฐัะธั ะพ ัะตะบััะตะผ ะทะฐะปะพะณะธะฝะตะฝะฝะพะผ ะฟะพะปัะทะพะฒะฐัะตะปะต.
*   **ะะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั**: ะฃัะธะปััะต ะฒะฐะปะธะดะฐัะธั ะฒ ัะตัะธะฐะปะธะทะฐัะพัะฐั (`myapp/serializers.py`).
*   **ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั**: ะะพะปะฝะพัััั ะฟะตัะตะฝะตัะธัะต ะฒัะต ัะตะบัะตัั ะธ ะฝะฐัััะพะนะบะธ ะธะท ะบะพะดะฐ ะฒ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั, ะธัะฟะพะปัะทัั `.env` ัะฐะนะปั.
*   **ะขะตััะธัะพะฒะฐะฝะธะต**: ะะฐััะธัััะต ะฟะพะบัััะธะต ัะตััะฐะผะธ (`myapp/tests.py`), ะดะพะฑะฐะฒะธะฒ ัะตััั ะดะปั ะฝะพะฒะพะน ะปะพะณะธะบะธ ะฐััะตะฝัะธัะธะบะฐัะธะธ ะธ API ัะฝะดะฟะพะธะฝัะพะฒ.
